<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>회원가입</title>
    <link rel="stylesheet" href="Login.css" />
  </head>
  <body style="background-color:#f8fef3;">
    <div id="signup">
      <div id="mem_title">
        <img src="title_icon.png" style="width:24px" alt="">
        <span style="margin-left:4px;">회원가입</span>
      </div>

      <form id="signupForm">
        <ul id="mem_form">
          <li class="row">
            <ul class="item">
              <li class="col1"><span style="margin-left:4px;">아이디</span></li>
              <li class="col2">
                <ul>
                  <li>
                    <input type="text" name="username" id="username" minlength="5" maxlength="10" pattern="[a-zA-Z0-9]+" required>
                  </li>
                  <li style="margin-left:4px;">영문, 숫자 조합으로 5~10자 이내</li>
                </ul>
              </li>
            </ul>
          </li>

          <li class="row">
            <ul class="item">
              <li class="col1"><span style="margin-left:4px;">비밀번호</span></li>
              <li class="col2">
                <ul>
                  <li><input type="password" name="password" id="password" minlength="5" maxlength="10" required></li>
                  <li style="margin-left:4px;">영문, 숫자 조합으로 5~10자 이내</li>
                </ul>
              </li>
            </ul>
          </li>

          <li class="row">
            <ul class="item">
              <li class="col1"><span style="margin-left:4px;">비밀번호 확인</span></li>
              <li class="col2"><ul><li><input type="password" id="password2" required></li></ul></li>
            </ul>
          </li>

          <li class="row" id="name">
            <ul class="item">
              <li class="col1"><span style="margin-left:4px;">이름</span></li>
              <li class="col2"><ul><li><input type="text" name="name" id="nameInput" required></li></ul></li>
            </ul>
          </li>

          <li class="row" id="birthday">
            <ul class="item">
              <li class="col1"><span style="margin-left:4px;">생년월일</span></li>
              <li class="col2">
                <ul>
                  <li><input style="width:100px" type="text" name="birth" id="birth" pattern="[0-9]{6}" placeholder="YYMMDD" required></li>
                  <li style="margin-left:4px;">주민등록번호 앞 6자리</li>
                </ul>
              </li>
            </ul>
          </li>

          <li class="row" id="email">
            <ul class="item">
              <li class="col1"><span style="margin-left:4px;">이메일</span></li>
              <li class="col2"><ul><li><input type="email" name="email" id="emailInput" required></li></ul></li>
            </ul>
          </li>

          <li class="row">
            <ul class="item">
              <li class="col1"><span style="margin-left:4px;">휴대전화</span></li>
              <li class="col2">
                <ul>
                  <li><input style="width:30px" type="text" id="phone1" pattern="[0-9]{2,3}" required></li>
                  <li>-</li>
                  <li><input style="width:40px" type="text" id="phone2" pattern="[0-9]{3,4}" required></li>
                  <li>-</li>
                  <li><input style="width:40px" type="text" id="phone3" pattern="[0-9]{4}" required></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>

        <div id="buttons">
          <button type="submit" id="btnSignup">
            <img style="margin-right:4px;width:24px" src="check_icon.png" alt="">가입하기
          </button>
          <div id="msg" style="margin-top:8px;color:#d00;"></div>
        </div>
      </form>

      <!-- 성공 화면 영역 -->
      <div id="successBox" style="display:none; padding:16px 12px;"></div>
    </div>

    <!-- 가입 요청 JS -->
    <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const form = document.getElementById('signupForm');
      const msg  = document.getElementById('msg');
      const box  = document.getElementById('successBox');
      const btn  = document.getElementById('btnSignup');
      let submitting = false;

      function showSuccess(data){
        form.style.display = 'none';
        // const asciiId = data?.asciiMapId ?? '(알 수 없음)';
        // const txId    = data?.txId       ?? '(알 수 없음)';
        const sessionkey  = data?.session_key ?? '(알 수 없음)';
        const txId        = data?.txid      ?? '(알 수 없음)';
        box.innerHTML = `
          <div style="border:1px solid #cfe3cf;background:#f0fff0;border-radius:8px;padding:20px;">
            <h3 style="margin:0 0 8px 0;color:#16803c;">가입 완료!</h3>
            <p style="margin:6px 0;">매핑ID: <code>${sessionkey}</code></p>
            <p style="margin:6px 0;">체인 tx: <code>${txId}</code></p>
            <p style="margin:14px 0 18px 0;">이 탭/창을 닫고 <strong>시스템에서 로그인</strong> 해 주세요.</p>
            <button id="btnClose" style="padding:8px 12px;border:1px solid #bcd0bc;border-radius:6px;background:#fff;cursor:pointer;">
              창 닫기
            </button>
          </div>`;
        box.style.display = 'block';
        box.scrollIntoView({behavior:'smooth', block:'start'});
        document.getElementById('btnClose').addEventListener('click', ()=>{
          try { window.close(); if (!window.closed) { window.open('','_self'); window.close(); } } catch(e){}
        });
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (submitting) return;
        submitting = true;
        btn.disabled = true;
        msg.textContent = '';

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const password2= document.getElementById('password2').value;
        const name     = document.getElementById('nameInput').value.trim();
        const birth    = document.getElementById('birth').value.trim();
        const email    = document.getElementById('emailInput').value.trim();
        const p1 = document.getElementById('phone1').value;
        const p2 = document.getElementById('phone2').value;
        const p3 = document.getElementById('phone3').value;

        if (password !== password2){
          msg.textContent = '비밀번호가 일치하지 않습니다.';
          submitting = false; btn.disabled = false; return;
        }

        //const body = { username, password, name, birth, email, phone: [p1,p2,p3].join('-') };
        const body = { user_id: username, password};

        try{
          //const res = await fetch('http://127.0.0.1:5000/api/signup', {
          const res = await fetch('http://127.0.0.1:5000/api/register', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(body)
          });

          // JSON 보장 체크
          const ct = res.headers.get('content-type') || '';
          let data = null;
          if (ct.includes('application/json')) {
            data = await res.json();
          } else {
            await res.text(); // HTML 등
          }

          if (!res.ok) throw new Error(data?.error || `가입 실패 (HTTP ${res.status})`);
          showSuccess(data);

        } catch(err){
          console.error(err);
          msg.textContent = err.message || '네트워크 오류';
        } finally {
          submitting = false;
          btn.disabled = false;
        }
      });
    });
    </script>
  </body>
</html>